#!/usr/bin/env ruby
# -*- coding: utf-8 -*-

# Copyright (C) 2014  Thilo Fischer.
# Free software licensed under GPL v3. See LICENSE.txt for details.

module Ooccor

  require 'optparse'

  require 'ooccor'

  # * parse command line arguments

  options = {}
  option_parser = OptionParser.new do |opts|

    opts.banner = "Usage: #{File.basename $0} [options] [-c compiler [compiler-arguments]] [sourcefiles]"

    opts.on("-e 'command'",
            "--expression",
            "Run expression instead of starting an interactive sessios.") do |arg|
      options[:expression] = arg
    end

    opts.on("-c compiler",
            "--compiler",
            $supported_compilers.keys,
            "Parse compiler arguments according to the given compiler.",
            " (Currently supported: #{$supported_compilers.keys.map{|s| s.to_s}.join(', ')})",
            " Has to be the last ooccor argument, all following arguments are regarded as arguments to the compiler.") do |arg|
      throw :compiler, $supported_compilers[arg].new
    end

    opts.on("--init",
            "Set up and fill the code analysis cache. Clear and rebuild if cache already exists.") do
      options[:init] = true
    end

    
    opts.on("-F",
            "--on-the-fly",
            "Parse the code directly when processing it, do not use code analysis cache.") do
      options[:on_the_fly] = true
    end

    opts.on("-v 'verbosity'",
            "--verbosity",
            "Set log level of ooccor session.") do |arg|
      options[:verbosity] = arg
    end

  end

  # ** parse all arguments until a --compiler argument

  compiler = catch :compiler do
    option_parser.order!
    # return nil from catch block if not catched
    nil
  end

  # ** handle Compiler arguments (after --compiler argument)

  if compiler
    compiler.parse_argv
  end

  # * set up session's environment

  $env = Environment.new(options, compiler)

  # * assemble input data

  if options[:read_stdin]
    # fixme: which is better, 'chomp' or 'chomp!' ?
    # fixme: enable reading stdin _in addition_ to ordinary files
    files = [ CodeObjects::CoFile.new($env.program, "<stdin>", STDIN.readlines.map(&:chomp!)) ]
  else
    files = ARGV.map { |f| CodeObjects::CoFile.new($env.program, f) }
  end


  # * set up logging

  log = Logger.new(STDOUT)

  # * parse input
  
  files.map { |f| f.expand(ProcessingEnvironment.new($env.program)) }

  # * run commands
  
  if options[:expression] then
    Commands::Command.invoke($env, options[:expression])
  end

  # Todo: When starting interactive session:
  #  <program>  Copyright (C) <year>  <name of author>
  #  This program comes with ABSOLUTELY NO WARRANTY; for details type `show w'.
  #  This is free software, and you are welcome to redistribute it
  #  under certain conditions; type `show c' for details.

end # module Ooccor
